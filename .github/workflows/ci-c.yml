name: CI Quality (LLVM style + Static/Dynamic) - C/C++/Python/Java

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # =========================
  # C ONLY
  # =========================
  quality-c:
    name: C (LLVM format + static + dynamic)
    runs-on: ubuntu-24.04
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4

      - name: Detect C files
        id: ccheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.c" ! -path "./.git/*" | grep -q .; then
            echo "has_c=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_c=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install C tools (only if C exists, pinned clang 18)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang-18 clang-format-18 clang-tidy-18 \
            cppcheck valgrind

          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 100
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-18 100

      # -------------------------
      # 1) LLVM STYLE CHECK
      # -------------------------
      - name: Check LLVM style (clang-format) [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FMT_FILES < <(find . -type f \( -name "*.c" -o -name "*.h" \) ! -path "./.git/*")
          if [ "${#FMT_FILES[@]}" -eq 0 ]; then
            echo "No C files -> skipping format check"
            exit 0
          fi
          for f in "${FMT_FILES[@]}"; do
            clang-format -style=LLVM "$f" | diff -u "$f" - >/dev/null || {
              echo "::error file=$f::clang-format LLVM mismatch. Fix with: clang-format -style=LLVM -i $f"
              exit 1
            }
          done

      # -------------------------
      # 2) STATIC ANALYSIS
      # -------------------------
      - name: Static analysis (cppcheck) [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cppcheck --enable=all --inconclusive \
            --inline-suppr --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            .

      - name: Static analysis (clang-tidy if compile_commands.json exists) [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f compile_commands.json ]; then
            echo "No compile_commands.json -> skipping clang-tidy"
            exit 0
          fi
          mapfile -t TIDY_FILES < <(find . -type f -name "*.c" ! -path "./.git/*")
          if [ "${#TIDY_FILES[@]}" -eq 0 ]; then
            echo "No .c files -> skipping clang-tidy"
            exit 0
          fi
          clang-tidy -p . \
            -checks="-*,clang-analyzer-*" \
            "${TIDY_FILES[@]}"

      # -------------------------
      # 3) BUILD (compile everything, no linking)
      # -------------------------
      - name: Compile all C translation units (no linking)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build_c/obj
          mapfile -t C_FILES < <(find . -type f -name "*.c" ! -path "./.git/*")
          for f in "${C_FILES[@]}"; do
            out="build_c/obj/$(echo "$f" | sed 's|^\./||; s|/|_|g').o"
            echo "CC  $f"
            gcc -std=c11 -Wall -Wextra -Werror -O2 -c "$f" -o "$out"
          done

      # -------------------------
      # 4) DYNAMIC ANALYSIS (only if exactly one main)
      # -------------------------
      - name: Link & run with sanitizers + valgrind (only if exactly one main) [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t MAIN_FILES < <(
            grep -Rsn --include="*.c" -E '^\s*int\s+main\s*\(' . | cut -d: -f1 | sort -u
          )

          if [ "${#MAIN_FILES[@]}" -eq 0 ]; then
            echo "No main() found -> skipping dynamic analysis"
            exit 0
          fi
          if [ "${#MAIN_FILES[@]}" -ne 1 ]; then
            echo "Multiple main() found -> skipping link/run"
            printf '%s\n' "${MAIN_FILES[@]}"
            exit 0
          fi

          mkdir -p build_c
          mapfile -t C_FILES < <(find . -type f -name "*.c" ! -path "./.git/*")

          echo "Linking with clang-18 + ASan/UBSan"
          clang -std=c11 -Wall -Wextra -Werror -O1 -g \
            -fsanitize=address,undefined -fno-omit-frame-pointer \
            "${C_FILES[@]}" -o build_c/app_san

          echo "Run (sanitizers):"
          ./build_c/app_san

          echo "Run (valgrind):"
          valgrind --error-exitcode=1 --leak-check=full ./build_c/app_san

      - name: C skipped (no .c)
        if: steps.ccheck.outputs.has_c != 'true'
        run: echo "No .c files found -> skipping C job"

  # =========================
  # C++ ONLY
  # =========================
  quality-cpp:
    name: C++ (LLVM format + static + dynamic)
    runs-on: ubuntu-24.04
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4

      - name: Detect C++ files
        id: cppcheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.hxx" -o -name "*.cc" -o -name "*.cxx" \) ! -path "./.git/*" | grep -q .; then
            echo "has_cpp=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_cpp=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install C++ tools (only if C++ exists, pinned clang 18)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            clang-18 clang++-18 \
            clang-format-18 clang-tidy-18 \
            cppcheck valgrind

          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-18 100
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-18 100
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 100
          sudo update-alternatives --install /usr/bin/clang-tidy clang-tidy /usr/bin/clang-tidy-18 100

      # -------------------------
      # 1) LLVM STYLE CHECK
      # -------------------------
      - name: Check LLVM style (clang-format) [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FMT_FILES < <(
            find . -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.hxx" -o -name "*.cc" -o -name "*.cxx" -o -name "*.h" \) \
              ! -path "./.git/*"
          )
          if [ "${#FMT_FILES[@]}" -eq 0 ]; then
            echo "No C++ files -> skipping format check"
            exit 0
          fi
          for f in "${FMT_FILES[@]}"; do
            clang-format -style=LLVM "$f" | diff -u "$f" - >/dev/null || {
              echo "::error file=$f::clang-format LLVM mismatch. Fix with: clang-format -style=LLVM -i $f"
              exit 1
            }
          done

      # -------------------------
      # 2) STATIC ANALYSIS
      # -------------------------
      - name: Static analysis (cppcheck) [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cppcheck --enable=all --inconclusive \
            --inline-suppr --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            .

      - name: Static analysis (clang-tidy if compile_commands.json exists) [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f compile_commands.json ]; then
            echo "No compile_commands.json -> skipping clang-tidy"
            exit 0
          fi
          mapfile -t TIDY_FILES < <(
            find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" \) ! -path "./.git/*"
          )
          if [ "${#TIDY_FILES[@]}" -eq 0 ]; then
            echo "No C++ sources -> skipping clang-tidy"
            exit 0
          fi
          clang-tidy -p . \
            -checks="-*,clang-analyzer-*,bugprone-*,performance-*,readability-*" \
            "${TIDY_FILES[@]}"

      # -------------------------
      # 3) BUILD (compile everything, no linking)
      # -------------------------
      - name: Compile all C++ translation units (no linking)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build_cpp/obj
          mapfile -t CPP_FILES < <(
            find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" \) ! -path "./.git/*"
          )
          for f in "${CPP_FILES[@]}"; do
            out="build_cpp/obj/$(echo "$f" | sed 's|^\./||; s|/|_|g').o"
            echo "CXX $f"
            g++ -std=c++17 -Wall -Wextra -Werror -O2 -c "$f" -o "$out"
          done

      # -------------------------
      # 4) DYNAMIC ANALYSIS (only if exactly one main)
      # -------------------------
      - name: Link & run with sanitizers + valgrind (only if exactly one main) [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t MAIN_FILES < <(
            grep -Rsn --include="*.cpp" --include="*.cc" --include="*.cxx" -E '^\s*(int|auto)\s+main\s*\(' . \
              | cut -d: -f1 | sort -u
          )

          if [ "${#MAIN_FILES[@]}" -eq 0 ]; then
            echo "No main() found -> skipping dynamic analysis"
            exit 0
          fi
          if [ "${#MAIN_FILES[@]}" -ne 1 ]; then
            echo "Multiple main() found -> skipping link/run"
            printf '%s\n' "${MAIN_FILES[@]}"
            exit 0
          fi

          mkdir -p build_cpp
          mapfile -t CPP_FILES < <(
            find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" \) ! -path "./.git/*"
          )

          echo "Linking with clang++-18 + ASan/UBSan"
          clang++ -std=c++17 -Wall -Wextra -Werror -O1 -g \
            -fsanitize=address,undefined -fno-omit-frame-pointer \
            "${CPP_FILES[@]}" -o build_cpp/app_san

          echo "Run (sanitizers):"
          ./build_cpp/app_san

          echo "Run (valgrind):"
          valgrind --error-exitcode=1 --leak-check=full ./build_cpp/app_san

      - name: C++ skipped (no C++ sources)
        if: steps.cppcheck.outputs.has_cpp != 'true'
        run: echo "No C++ files found -> skipping C++ job"

  # =========================
  # PYTHON
  # =========================
  quality-python:
    name: Python (format + static + compile + tests/run)
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Detect Python files
        id: pycheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.py" ! -path "./.git/*" | grep -q .; then
            echo "has_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_py=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-python@v5
        if: steps.pycheck.outputs.has_py == 'true'
        with:
          python-version: "3.11"

      - name: Install Python quality tools (only if Python exists)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install ruff mypy pytest

      - name: Python format check (ruff format)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          ruff format --check .

      - name: Python lint (ruff)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          ruff check .

      - name: Python type-check (mypy, best-effort)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mypy . || true

      - name: Python syntax check (compileall)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall -q .

      - name: Python tests (pytest if present, else run single script if unique)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "tests" ] || find . -maxdepth 3 -type f -name "test_*.py" | grep -q .; then
            pytest -q
            exit 0
          fi

          mapfile -t PY_FILES < <(find . -type f -name "*.py" ! -path "./.git/*" | sort)
          if [ "${#PY_FILES[@]}" -eq 1 ]; then
            echo "No tests found. Running single script: ${PY_FILES[0]}"
            python -u "${PY_FILES[0]}"
          else
            echo "No tests and multiple .py files -> skipping run"
          fi

      - name: Python skipped (no .py)
        if: steps.pycheck.outputs.has_py != 'true'
        run: echo "No .py files found -> skipping"

  # =========================
  # JAVA
  # =========================
  quality-java:
    name: Java (style + static + compile + tests/run)
    runs-on: ubuntu-24.04
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4

      - name: Detect Java files
        id: javacheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.java" ! -path "./.git/*" | grep -q .; then
            echo "has_java=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_java=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-java@v4
        if: steps.javacheck.outputs.has_java == 'true'
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Java static tools (only if Java exists)
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends checkstyle spotbugs

      - name: Java style check (Checkstyle - basic)
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cat > checkstyle.xml <<'XML'
          <!DOCTYPE module PUBLIC
            "-//Checkstyle//DTD Checkstyle Configuration 1.3//EN"
            "https://checkstyle.org/dtds/configuration_1_3.dtd">
          <module name="Checker">
            <module name="TreeWalker">
              <module name="NeedBraces"/>
              <module name="UnusedImports"/>
              <module name="AvoidStarImport"/>
              <module name="LineLength">
                <property name="max" value="120"/>
              </module>
            </module>
          </module>
          XML

          mapfile -t JAVA_FILES < <(find . -type f -name "*.java" ! -path "./.git/*")
          checkstyle -c checkstyle.xml "${JAVA_FILES[@]}"

      - name: Compile all Java files
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          mapfile -t JAVA_FILES < <(find . -type f -name "*.java" ! -path "./.git/*")
          javac -d out "${JAVA_FILES[@]}"

      - name: Static analysis (SpotBugs) (best-effort)
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d out ]; then
            echo "No compiled classes -> skipping spotbugs"
            exit 0
          fi
          spotbugs -textui -effort:max -high -classpath out -auxclasspath out out || true

      - name: Run tests if Maven/Gradle, else run if exactly one main
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail

          if [ -f "pom.xml" ]; then
            echo "pom.xml found -> running mvn test"
            sudo apt-get update && sudo apt-get install -y maven
            mvn -q test
            exit 0
          fi
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "gradle build found -> running gradle test"
            sudo apt-get update && sudo apt-get install -y gradle
            gradle test
            exit 0
          fi

          mapfile -t MAIN_SRCS < <(grep -Rsl --include="*.java" "public static void main" . | sort)
          if [ "${#MAIN_SRCS[@]}" -eq 0 ]; then
            echo "No main() found -> skipping run"
            exit 0
          fi
          if [ "${#MAIN_SRCS[@]}" -ne 1 ]; then
            echo "Multiple main() found -> skipping run"
            printf '%s\n' "${MAIN_SRCS[@]}"
            exit 0
          fi

          MAIN_SRC="${MAIN_SRCS[0]}"
          PKG=$(grep -E "^\s*package\s+" "$MAIN_SRC" | head -n 1 | sed -E 's/^\s*package\s+([a-zA-Z0-9_.]+)\s*;\s*$/\1/' || true)
          CLS=$(grep -E "class\s+[A-Za-z_][A-Za-z0-9_]*" "$MAIN_SRC" | head -n 1 | sed -E 's/.*class\s+([A-Za-z_][A-Za-z0-9_]*).*/\1/')

          if [ -z "$CLS" ]; then
            echo "Could not detect class name -> skipping run"
            exit 0
          fi

          if [ -n "$PKG" ]; then MAIN="$PKG.$CLS"; else MAIN="$CLS"; fi
          echo "Running Java main: $MAIN"
          java -cp out "$MAIN"

      - name: Java skipped (no .java)
        if: steps.javacheck.outputs.has_java != 'true'
        run: echo "No .java files found -> skipping"
