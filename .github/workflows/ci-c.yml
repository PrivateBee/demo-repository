name: "CI Quality (C/C++/Python/Java) - run ONLY matching OS (unix vs windows)"

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ==========================================================
  # Detect origin OS (heuristic): CRLF => windows else unix
  # ==========================================================
  detect-origin:
    name: "Detect origin (windows vs unix)"
    runs-on: ubuntu-24.04
    outputs:
      origin: ${{ steps.detector.outputs.origin }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect origin by CRLF in tracked sources
        id: detector
        shell: bash
        run: |
          set -euo pipefail
          FILES="$(git ls-files \
            '*.c' '*.h' '*.cpp' '*.hpp' '*.hxx' '*.cc' '*.cxx' \
            '*.py' '*.java' '*.yml' '*.yaml' '*.sh' '*.md' || true)"

          if [ -z "${FILES}" ]; then
            echo "origin=unix" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if printf "%s\n" "$FILES" | xargs -r grep -Il $'\r' -- >/dev/null 2>&1; then
            echo "origin=windows" >> "$GITHUB_OUTPUT"
          else
            echo "origin=unix" >> "$GITHUB_OUTPUT"
          fi

      - name: Show detected origin
        run: echo "Detected origin = ${{ steps.detector.outputs.origin }}"

  # ==========================================================
  # C - UNIX (Linux + macOS)
  # ==========================================================
  quality-c-unix:
    name: "C Quality (unix) on ${{ matrix.os }}"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'unix'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Detect C files
        id: ccheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.c" ! -path "./.git/*" | grep -q .; then
            echo "has_c=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_c=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install C tools (Linux)
        if: steps.ccheck.outputs.has_c == 'true' && runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang clang-format clang-tidy cppcheck

      - name: Install C tools (macOS)
        if: steps.ccheck.outputs.has_c == 'true' && runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install llvm cppcheck
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: clang-format (LLVM) check [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          find . -type f \( -name "*.c" -o -name "*.h" \) ! -path "./.git/*" -print0 \
            | xargs -0 -I{} clang-format -style=LLVM -i "{}"
          git diff --exit-code

      - name: Static analysis (cppcheck) [C]
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cppcheck --enable=all --inconclusive \
            --inline-suppr --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            .

      - name: Compile all C units (no linking)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build_c/obj
          while IFS= read -r f; do
            out="build_c/obj/$(echo "$f" | sed 's|^\./||; s|/|_|g').o"
            clang -std=c11 -Wall -Wextra -Werror -O2 -c "$f" -o "$out"
          done < <(find . -type f -name "*.c" ! -path "./.git/*")

      - name: C skipped (no .c)
        if: steps.ccheck.outputs.has_c != 'true'
        run: echo "No .c files -> skipping"

  # ==========================================================
  # C - WINDOWS
  # ==========================================================
  quality-c-windows:
    name: "C Quality (windows)"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'windows'
    runs-on: windows-2022
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Git EOL settings (Windows)
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Detect C files
        id: ccheck
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $files = Get-ChildItem -Recurse -File -Include *.c
          if ($files.Count -gt 0) { "has_c=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }
          else { "has_c=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }

      - name: Install C tools (Windows)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"

          # 1. Force l'installation de cppcheck
          choco install -y llvm cppcheck --no-progress

          # 2. Ajout immédiat de LLVM au PATH de la session et de l'Action
          $llvmBin = "C:\Program Files\LLVM\bin"
          if (Test-Path $llvmBin) {
            $llvmBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            $env:PATH = "$llvmBin;$env:PATH"
          }

          # 3. Localisation dynamique et création d'un alias
          # On cherche dans les dossiers standards de Chocolatey et Program Files
          $cppExe = Get-ChildItem -Path "C:\Program Files\Cppcheck", "C:\ProgramData\chocolatey\bin" -Filter "cppcheck.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName

          if ($null -eq $cppExe) {
              # Si tjs pas trouvé, on tente un "where"
              $cppExe = where.exe cppcheck.exe | Select-Object -First 1
          }

          if ($null -ne $cppExe) {
              Write-Host "Cppcheck trouvé ici : $cppExe"
              $cppDir = Split-Path -Parent $cppExe
              $cppDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
              
              # LA SOLUTION : Créer un alias pour la session actuelle
              New-Alias -Name cppcheck -Value $cppExe -Scope Global
          } else {
              throw "Impossible de localiser cppcheck.exe après l'installation."
          }

          # 4. Vérification
          clang-format --version
          cppcheck --version # Devrait maintenant fonctionner via l'alias
      - name: clang-format (LLVM) check [C] (Windows)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          Get-ChildItem -Recurse -File -Include *.c,*.h |
            Where-Object { $_.FullName -notmatch "\\.git\\" } |
            ForEach-Object { & clang-format -style=LLVM -i $_.FullName }
          git diff --exit-code

      - name: Static analysis (cppcheck) [C] (Windows)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          cppcheck --enable=all --inconclusive --inline-suppr --error-exitcode=1 --suppress=missingIncludeSystem .

      - name: Compile all C units (Windows) (no linking)
        if: steps.ccheck.outputs.has_c == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          New-Item -ItemType Directory -Force -Path build_c/obj | Out-Null
          $files = Get-ChildItem -Recurse -File -Include *.c | Where-Object { $_.FullName -notmatch "\\.git\\" }
          foreach ($f in $files) {
            $safe = ($f.FullName -replace '^[A-Za-z]:\\', '' -replace '[\\/]', '_')
            & clang -std=c11 -Wall -Wextra -Werror -O2 -c $f.FullName -o "build_c/obj/$safe.obj"
          }

      - name: C skipped (no .c)
        if: steps.ccheck.outputs.has_c != 'true'
        run: echo "No .c files -> skipping"

  # ==========================================================
  # C++ - UNIX (Linux + macOS)
  # ==========================================================
  quality-cpp-unix:
    name: "C++ Quality (unix) on ${{ matrix.os }}"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'unix'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Detect C++ files
        id: cppcheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" -o -name "*.hpp" -o -name "*.hxx" \) ! -path "./.git/*" | grep -q .; then
            echo "has_cpp=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_cpp=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install C++ tools (Linux)
        if: steps.cppcheck.outputs.has_cpp == 'true' && runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends clang clang++ clang-format clang-tidy cppcheck

      - name: Install C++ tools (macOS)
        if: steps.cppcheck.outputs.has_cpp == 'true' && runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install llvm cppcheck
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: clang-format (LLVM) check [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" -o -name "*.hpp" -o -name "*.hxx" -o -name "*.h" \) ! -path "./.git/*" -print0 \
            | xargs -0 -I{} clang-format -style=LLVM -i "{}"
          git diff --exit-code

      - name: Static analysis (cppcheck) [C++]
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cppcheck --enable=all --inconclusive \
            --inline-suppr --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            .

      - name: Compile all C++ units (no linking)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build_cpp/obj
          while IFS= read -r f; do
            out="build_cpp/obj/$(echo "$f" | sed 's|^\./||; s|/|_|g').o"
            clang++ -std=c++17 -Wall -Wextra -Werror -O2 -c "$f" -o "$out"
          done < <(find . -type f \( -name "*.cpp" -o -name "*.cc" -o -name "*.cxx" \) ! -path "./.git/*")

      - name: C++ skipped (no sources)
        if: steps.cppcheck.outputs.has_cpp != 'true'
        run: echo "No C++ files -> skipping"

  # ==========================================================
  # C++ - WINDOWS
  # ==========================================================
  quality-cpp-windows:
    name: "C++ Quality (windows)"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'windows'
    runs-on: windows-2022
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Git EOL settings (Windows)
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Detect C++ files
        id: cppcheck
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $files = Get-ChildItem -Recurse -File -Include *.cpp,*.cc,*.cxx
          if ($files.Count -gt 0) { "has_cpp=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }
          else { "has_cpp=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }

      - name: Install C++ tools (Windows)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"

          choco install -y llvm cppcheck

          $llvmBin = "C:\Program Files\LLVM\bin"
          if (Test-Path $llvmBin) { $llvmBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append }

          $candidates = @(
            "C:\Program Files\Cppcheck\cppcheck.exe",
            "C:\Program Files (x86)\Cppcheck\cppcheck.exe",
            "C:\ProgramData\chocolatey\bin\cppcheck.exe"
          )

          $found = $candidates | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $found) {
            $found = Get-ChildItem -Path "C:\Program Files","C:\Program Files (x86)","C:\ProgramData\chocolatey" `
              -Recurse -File -Filter "cppcheck.exe" -ErrorAction SilentlyContinue `
              | Select-Object -First 1 -ExpandProperty FullName
          }

          if (-not $found) {
            Write-Host "cppcheck.exe not found. Debug info:"
            where.exe cppcheck 2>$null || Write-Host "where cppcheck: not found"
            choco list --local-only | findstr /I cppcheck
            throw "cppcheck installation appears to have failed or path not found."
          }

          $cppDir = Split-Path -Parent $found
          $cppDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          clang-format --version
          cppcheck --version

      - name: clang-format (LLVM) check [C++] (Windows)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          Get-ChildItem -Recurse -File -Include *.cpp,*.cc,*.cxx,*.hpp,*.hxx,*.h |
            Where-Object { $_.FullName -notmatch "\\.git\\" } |
            ForEach-Object { & clang-format -style=LLVM -i $_.FullName }
          git diff --exit-code

      - name: Static analysis (cppcheck) [C++] (Windows)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          cppcheck --enable=all --inconclusive --inline-suppr --error-exitcode=1 --suppress=missingIncludeSystem .

      - name: Compile all C++ units (Windows) (no linking)
        if: steps.cppcheck.outputs.has_cpp == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          New-Item -ItemType Directory -Force -Path build_cpp/obj | Out-Null
          $files = Get-ChildItem -Recurse -File -Include *.cpp,*.cc,*.cxx | Where-Object { $_.FullName -notmatch "\\.git\\" }
          foreach ($f in $files) {
            $safe = ($f.FullName -replace '^[A-Za-z]:\\', '' -replace '[\\/]', '_')
            & clang++ -std=c++17 -Wall -Wextra -Werror -O2 -c $f.FullName -o "build_cpp/obj/$safe.obj"
          }

      - name: C++ skipped (no sources)
        if: steps.cppcheck.outputs.has_cpp != 'true'
        run: echo "No C++ files -> skipping"

  # ==========================================================
  # PYTHON - UNIX (Linux + macOS)
  # ==========================================================
  quality-python-unix:
    name: "Python Quality (unix) on ${{ matrix.os }}"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'unix'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Detect Python files
        id: pycheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.py" ! -path "./.git/*" | grep -q .; then
            echo "has_py=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_py=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-python@v5
        if: steps.pycheck.outputs.has_py == 'true'
        with:
          python-version: "3.11"

      - name: Install tools
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install ruff mypy pytest

      - name: Ruff format check
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m ruff format --check .

      - name: Ruff lint
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m ruff check .

      - name: Mypy (best-effort)
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m mypy . || true

      - name: Compileall
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m compileall -q .

      - name: Pytest if present
        if: steps.pycheck.outputs.has_py == 'true'
        shell: bash
        run: |
          set -euo pipefail
          if [ -d "tests" ] || find . -maxdepth 3 -type f -name "test_*.py" | grep -q .; then
            python -m pytest -q
          else
            echo "No tests -> skipping"
          fi

      - name: Python skipped (no .py)
        if: steps.pycheck.outputs.has_py != 'true'
        run: echo "No .py -> skipping"

  # ==========================================================
  # PYTHON - WINDOWS
  # ==========================================================
  quality-python-windows:
    name: "Python Quality (windows)"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'windows'
    runs-on: windows-2022
    timeout-minutes: 12

    steps:
      - uses: actions/checkout@v4

      - name: Detect Python files
        id: pycheck
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $files = Get-ChildItem -Recurse -File -Include *.py
          if ($files.Count -gt 0) { "has_py=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }
          else { "has_py=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }

      - uses: actions/setup-python@v5
        if: steps.pycheck.outputs.has_py == 'true'
        with:
          python-version: "3.11"

      - name: Install tools
        if: steps.pycheck.outputs.has_py == 'true'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff mypy pytest

      - name: Ruff format check
        if: steps.pycheck.outputs.has_py == 'true'
        shell: pwsh
        run: |
          python -m ruff format --check .

      - name: Ruff lint
        if: steps.pycheck.outputs.has_py == 'true'
        shell: pwsh
        run: |
          python -m ruff check .

      - name: Compileall
        if: steps.pycheck.outputs.has_py == 'true'
        shell: pwsh
        run: |
          python -m compileall -q .

      - name: Pytest if present
        if: steps.pycheck.outputs.has_py == 'true'
        shell: pwsh
        run: |
          if (Test-Path "tests") { python -m pytest -q }
          else { Write-Host "No tests folder -> skipping" }

      - name: Python skipped (no .py)
        if: steps.pycheck.outputs.has_py != 'true'
        run: echo "No .py -> skipping"

  # ==========================================================
  # JAVA - UNIX (Linux + macOS)
  # ==========================================================
  quality-java-unix:
    name: "Java Quality (unix) on ${{ matrix.os }}"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'unix'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Detect Java files
        id: javacheck
        shell: bash
        run: |
          set -euo pipefail
          if find . -type f -name "*.java" ! -path "./.git/*" | grep -q .; then
            echo "has_java=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_java=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/setup-java@v4
        if: steps.javacheck.outputs.has_java == 'true'
        with:
          distribution: temurin
          java-version: "17"

      - name: Compile all Java
        if: steps.javacheck.outputs.has_java == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          mapfile -t JAVA_FILES < <(find . -type f -name "*.java" ! -path "./.git/*")
          javac -d out "${JAVA_FILES[@]}"

      - name: Java skipped (no .java)
        if: steps.javacheck.outputs.has_java != 'true'
        run: echo "No .java -> skipping"

  # ==========================================================
  # JAVA - WINDOWS
  # ==========================================================
  quality-java-windows:
    name: "Java Quality (windows)"
    needs: [detect-origin]
    if: needs.detect-origin.outputs.origin == 'windows'
    runs-on: windows-2022
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Detect Java files
        id: javacheck
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          $files = Get-ChildItem -Recurse -File -Include *.java
          if ($files.Count -gt 0) { "has_java=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }
          else { "has_java=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8 }

      - uses: actions/setup-java@v4
        if: steps.javacheck.outputs.has_java == 'true'
        with:
          distribution: temurin
          java-version: "17"

      - name: Compile all Java (Windows)
        if: steps.javacheck.outputs.has_java == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          New-Item -ItemType Directory -Force -Path out | Out-Null
          $files = Get-ChildItem -Recurse -File -Include *.java | Where-Object { $_.FullName -notmatch "\\.git\\" }
          $paths = $files | ForEach-Object { $_.FullName }
          if ($paths.Count -eq 0) { Write-Host "No Java files -> skipping"; exit 0 }
          & javac -d out $paths

      - name: Java skipped (no .java)
        if: steps.javacheck.outputs.has_java != 'true'
        run: echo "No .java -> skipping"
